<% training_start_date = (plan.race_date - plan.length.weeks).beginning_of_week %>
<% activities = Activity.where(plan_id: plan.id).index_by { |a| a.start_date_local.to_date } %>

<!-- Desktop Month View -->
<div class="hidden md:block">
  <div class="calendar-wrapper">
    <div class="calendar-grid">
      <div class="calendar-week-label">Week</div>
      <div class="calendar-header">M</div>
      <div class="calendar-header">Tu</div>
      <div class="calendar-header">W</div>
      <div class="calendar-header">Th</div>
      <div class="calendar-header">F</div>
      <div class="calendar-header">Sa</div>
      <div class="calendar-header">Su</div>

      <% plan.length.times do |week| %>
        <% week_start = training_start_date + (week * 7) %>
        <div class="calendar-week-label"><%= week_start.strftime("%m/%d") %></div>
        <div class="col-span-7">
          <div class="calendar-day-grid" data-controller="drag" data-drag-target="container" data-week="<%= week %>">
            <% 7.times do |day| %>
              <% current_date = week_start + day.days %>
              <% activity = activities[current_date] %>
              <div class="calendar-cell <%= 'calendar-cell-has' if activity %>" data-drag-target="item" data-activity-cell data-date="<%= current_date.to_s %>">
                <div class="flex-grow space-y-1 activity-content">
                  <% if activity %>
                    <div class="text-xs font-medium text-slate-800"><%= activity.distance %> mi</div>
                    <div class="text-[11px] text-slate-500 line-clamp-3"><%= activity.description %></div>
                  <% end %>
                </div>
                <button type="button"
                        class="calendar-edit-btn"
                        data-activity-modal-date-value="<%= current_date.to_s %>"
                        data-activity-modal-activity-value="<%= activity.to_json if activity %>"
                        data-activity-modal-activity-id-value="<%= activity&.id %>"
                        data-action="activity-modal#showModal">
                  <%= activity ? 'Edit' : 'Add' %>
                </button>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Mobile Month View - Compact Grid -->
<div class="md:hidden">
  <div class="space-y-4">
    <% plan.length.times do |week| %>
      <% week_start = training_start_date + (week * 7) %>
      <div class="card">
        <div class="card-section">
          <div class="text-sm font-medium text-slate-700 mb-3">
            Week <%= week + 1 %> â€¢ <%= week_start.strftime("%b %d") %> - <%= (week_start + 6.days).strftime("%b %d") %>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <% 7.times do |day| %>
              <% current_date = week_start + day.days %>
              <% activity = activities[current_date] %>
              <div class="mobile-day-card <%= 'mobile-day-card-has' if activity %>" data-activity-cell data-date="<%= current_date.to_s %>">
                <div class="flex items-center justify-between mb-1">
                  <div class="text-xs font-medium text-slate-600">
                    <%= current_date.strftime("%a %d") %>
                  </div>
                  <button type="button"
                          class="text-xs text-blue-600 hover:text-blue-800"
                          data-activity-modal-date-value="<%= current_date.to_s %>"
                          data-activity-modal-activity-value="<%= activity.to_json if activity %>"
                          data-activity-modal-activity-id-value="<%= activity&.id %>"
                          data-action="activity-modal#showModal">
                    <%= activity ? 'Edit' : '+' %>
                  </button>
                </div>
                <% if activity %>
                  <div class="text-xs font-medium text-slate-800"><%= activity.distance %> mi</div>
                  <div class="text-[10px] text-slate-500 line-clamp-2 mt-1"><%= activity.description %></div>
                <% else %>
                  <div class="text-[10px] text-slate-400">Rest day</div>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>