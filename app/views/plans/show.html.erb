<div data-controller="activity-modal">
  <div class="mx-auto md:w-2/3 w-full flex">
    <div class="mx-auto">
      <% if notice.present? %>
        <p class="py-2 px-3 bg-green-50 mb-5 text-green-500 font-medium rounded-lg inline-block" id="notice"><%= notice %></p>
      <% end %>
      <div class="flex flex-row items-center gap-2">
        <%= link_to "Edit this plan", edit_plan_path(@plan), class: "rounded-lg py-2 px-4 bg-gray-100 inline-block font-medium text-sm" %>
        <%= link_to "Back to plans", plans_path, class: "rounded-lg py-2 px-4 bg-gray-100 inline-block font-medium text-sm" %>
        <%= button_to "Destroy this plan", @plan, method: :delete, class: "rounded-lg py-2 px-4 bg-red-100 font-medium text-sm" %>
      </div>

      

      <%= render @plan %>
      <% training_start_date = @plan.race_date - 17.weeks %>

      <div class="mt-8 mb-4">
        <div class="grid grid-cols-8 gap-2">
          <%# Header row %>
          <div class="col-span-1"></div>
          <div class="font-semibold text-center">M</div>
          <div class="font-semibold text-center">Tu</div>
          <div class="font-semibold text-center">W</div>
          <div class="font-semibold text-center">Th</div>
          <div class="font-semibold text-center">F</div>
          <div class="font-semibold text-center">Sa</div>
          <div class="font-semibold text-center">Su</div>

          <%# Calendar grid %>
          <% training_start_date = @plan.race_date - 17.weeks %>
          <% training_start_date = training_start_date.beginning_of_week %>
          
          <% 18.times do |week| %>
            <% week_start = training_start_date + (week * 7) %>
            <%# Date column - not draggable %>
            <div class="font-medium text-sm py-2"><%= week_start.strftime("%m/%d") %></div>
            
            <%# Draggable cells container %>
            <div class="col-span-7" data-controller="drag">
              <div class="grid grid-cols-7 gap-2" 
                   data-drag-target="container"
                   data-week="<%= week %>">
                <% 7.times do |day| %>
                  <div class="h-24 aspect-square bg-gray-100 rounded-lg p-2 transition-all duration-200 ease-in-out" 
                       data-drag-target="item"
                       data-activity-cell
                       data-date="<%= (week_start + day.days).to_s %>">
                    <div class="h-full w-full flex flex-col">
                      <div class="flex-grow activity-content"></div>
                      <button type="button"
                              class="text-xs px-2 py-1 bg-gray-200 rounded mt-1 hover:bg-gray-300 opacity-50 hover:opacity-100 transition-opacity"
                              data-action="activity-modal#showModal">
                        Edit
                      </button>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <%# Modal Template - inside the activity-modal controller scope %>
  <div id="activity-modal" 
       data-activity-modal-target="modal"
       data-update-url="<%= activities_path %>"
       class="hidden fixed inset-0 z-50">
    <div class="fixed inset-0 bg-gray-600 bg-opacity-50"></div>
    
    <div class="relative z-50">
      <div class="fixed top-20 left-1/2 transform -translate-x-1/2 p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Edit Activity</h3>
          <form data-action="submit->activity-modal#save">
            <input type="hidden" data-activity-modal-target="dateInput" name="date">
            <textarea
              class="w-full p-2 border rounded-md"
              rows="4"
              placeholder="Enter activity details..."
              data-activity-modal-target="activityInput"
            ></textarea>
            <div class="mt-4 flex justify-end gap-2">
              <button type="button" 
                      class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300"
                      data-action="click->activity-modal#closeModal">
                Cancel
              </button>
              <button type="submit" 
                      class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                Save
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
